name: Deploy to Private Server (Docker)

on:
  push:
    branches: [main, master]

# ä»…ä¿ç•™æ— æ³•ä»é…ç½®æ–‡ä»¶è¯»å–çš„åŸºç¡€å˜é‡ï¼ˆæœåŠ¡å™¨ä¿¡æ¯ï¼‰
env:
  SERVER_HOST: ${{ vars.SERVER_HOST }}
  SERVER_USER: ${{ vars.SERVER_USER }}
  SERVER_PORT: ${{ vars.SERVER_PORT || '22' }}
  CONTAINER_LOG_PATH: /var/log  # å®¹å™¨å†…æ—¥å¿—è·¯å¾„ï¼ˆå›ºå®šå€¼ï¼‰

jobs:
  build-and-deploy-docker:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.24'

      # æ ¸å¿ƒç®€åŒ–ï¼šè°ƒç”¨é¡¹ç›®è„šæœ¬è¯»å–é…ç½®ï¼ˆä»…3è¡Œæ ¸å¿ƒä»£ç ï¼‰
      - name: ä»é…ç½®æ–‡ä»¶è¯»å–åº”ç”¨é…ç½®
        run: |
          echo "ğŸ” ä»config.iniè¯»å–APP_NAMEå’ŒAPP_PORT..."
          # è°ƒç”¨scripts/get_config.goè¯»å–é…ç½®ï¼ŒæŒ‡å®šé»˜è®¤å€¼
          APP_NAME=$(go run scripts/get_config.go app name "did-new")
          APP_PORT=$(go run scripts/get_config.go app port "50107")
          # å†™å…¥ç¯å¢ƒå˜é‡
          echo "APP_NAME=${APP_NAME}" >> $GITHUB_ENV
          echo "APP_PORT=${APP_PORT}" >> $GITHUB_ENV
          # æ‰“å°éªŒè¯
          echo "âœ… è¯»å–åˆ°é…ç½®ï¼šAPP_NAME=${APP_NAME}, APP_PORT=${APP_PORT}"

      # åŸæœ‰æ­¥éª¤ï¼šè®¾ç½®Dockerå˜é‡ï¼ˆé€»è¾‘ä¸å˜ï¼‰
      - name: Set Docker variables
        run: |
          echo "DOCKER_IMAGE_NAME=${{ env.APP_NAME }}" >> $GITHUB_ENV
          echo "DOCKER_CONTAINER_NAME=${{ env.APP_NAME }}-container" >> $GITHUB_ENV
          echo "SERVER_LOG_DIR=/home/deployer/log/${{ env.APP_NAME }}" >> $GITHUB_ENV
          echo "SERVER_VAR_LOG_DIR=/home/deployer/var_log/${{ env.APP_NAME }}" >> $GITHUB_ENV

      # ç§»é™¤Goåº”ç”¨æ„å»ºæ­¥éª¤ï¼Œå‰ç«¯æ˜¯é™æ€æ–‡ä»¶æ— éœ€ç¼–è¯‘

      - name: Build and save Docker image
        run: |
          echo "ğŸ³ æ„å»º Docker é•œåƒ..."
          docker build \
            --build-arg APP_NAME=${{ env.APP_NAME }} \
            --build-arg CONTAINER_PORT=${{ env.APP_PORT }} \
            -t ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }} .
          docker tag ${{ env.DOCKER_IMAGE_NAME }}:${{ github.sha }} ${{ env.DOCKER_IMAGE_NAME }}:latest
          docker save -o ${{ env.DOCKER_IMAGE_NAME }}.tar ${{ env.DOCKER_IMAGE_NAME }}:latest
          echo "âœ… Dockeré•œåƒæ„å»ºå¹¶ä¿å­˜å®Œæˆ"

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -p ${{ env.SERVER_PORT }} ${{ env.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Copy Docker files to server
        run: |
          echo "ğŸ“¤ ä¼ è¾“Dockeré•œåƒåˆ°æœåŠ¡å™¨..."
          ssh -p ${{ env.SERVER_PORT }} ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "mkdir -p /tmp/deploy"
          scp -P ${{ env.SERVER_PORT }} \
            ${{ env.DOCKER_IMAGE_NAME }}.tar \
            ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }}:/tmp/deploy/

      - name: Deploy with Docker on private server
        run: |
          echo "ğŸš€ åœ¨ç§é“¾æœåŠ¡å™¨æ‰§è¡ŒDockeréƒ¨ç½²..."
          # æå‰èµ‹å€¼å˜é‡ï¼Œé¿å…SSHå†…è½¬ä¹‰æ··ä¹±
          DOCKER_CONTAINER_NAME="${{ env.DOCKER_CONTAINER_NAME }}"
          APP_PORT="${{ env.APP_PORT }}"
          SERVER_VAR_LOG_DIR="${{ env.SERVER_VAR_LOG_DIR }}"
          SERVER_LOG_DIR="${{ env.SERVER_LOG_DIR }}"
          DOCKER_IMAGE_NAME="${{ env.DOCKER_IMAGE_NAME }}"
          SERVER_USER="${{ env.SERVER_USER }}"

          ssh -tt -p ${{ env.SERVER_PORT }} ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} << EOF
            set -e
            echo "=== å¼€å§‹Dockeréƒ¨ç½²ï¼ˆé˜¿é‡Œäº‘ CentOS 8ï¼‰ ==="
            echo "æ—¶é—´: \$(date)"
            echo "Commit: ${{ github.sha }}"
            echo "é…ç½®æ¥æºï¼šAPP_NAME=${{ env.APP_NAME }}, APP_PORT=${APP_PORT}"

            # å®‰è£…Dockerï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
            if ! command -v docker &> /dev/null; then
              echo "ğŸ“¦ å®‰è£…Docker..."
              sudo yum install -y yum-utils
              sudo yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
              sudo yum install -y docker-ce docker-ce-cli containerd.io
              sudo systemctl start docker
              sudo systemctl enable docker
              sudo usermod -aG docker ${SERVER_USER}
              newgrp docker
            fi

            # åˆ›å»ºæ—¥å¿—ç›®å½•
            sudo mkdir -p ${SERVER_LOG_DIR}
            sudo mkdir -p ${SERVER_VAR_LOG_DIR}
            sudo chown -R ${SERVER_USER}:${SERVER_USER} ${SERVER_LOG_DIR}
            sudo chown -R ${SERVER_USER}:${SERVER_USER} ${SERVER_VAR_LOG_DIR}
            sudo setenforce 0 2>/dev/null || true
            sudo restorecon -RvFi ${SERVER_LOG_DIR} 2>/dev/null || true
            sudo restorecon -RvFi ${SERVER_VAR_LOG_DIR} 2>/dev/null || true
            sudo chcon -R -t var_log_t ${SERVER_LOG_DIR} 2>/dev/null || true
            sudo chcon -R -t var_log_t ${SERVER_VAR_LOG_DIR} 2>/dev/null || true

            # åœæ­¢å¹¶åˆ é™¤æ—§å®¹å™¨
            echo "ğŸ”´ åœæ­¢æ—§å®¹å™¨..."
            docker stop ${DOCKER_CONTAINER_NAME} 2>/dev/null || true
            docker rm ${DOCKER_CONTAINER_NAME} 2>/dev/null || true

            # åŠ è½½æ–°é•œåƒ
            echo "ğŸ“¥ åŠ è½½Dockeré•œåƒ..."
            docker load -i /tmp/deploy/${DOCKER_IMAGE_NAME}.tar

            # å¯åŠ¨æ–°å®¹å™¨
            echo "ğŸŸ¢ å¯åŠ¨Dockerå®¹å™¨..."
            docker run -d --name ${DOCKER_CONTAINER_NAME} --restart always \
              -p ${APP_PORT}:50107 \
              ${DOCKER_IMAGE_NAME}:latest

            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            rm -rf /tmp/deploy/${DOCKER_IMAGE_NAME}.tar

            echo "âœ… é˜¿é‡Œäº‘ CentOS 8 Dockeréƒ¨ç½²å®Œæˆ"
            exit
          EOF

      - name: Verify deployment
        run: |
          echo "ğŸ” éªŒè¯Dockerå®¹å™¨éƒ¨ç½²..."
          sleep 10  # ç­‰å¾…Nginxå®¹å™¨å¯åŠ¨
          ssh -p ${{ env.SERVER_PORT }} ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "
            set -e
            echo '===== 1. éªŒè¯å®¹å™¨æ˜¯å¦è¿è¡Œ ====='
            CONTAINER_STATUS=\$(docker inspect -f '{{.State.Status}}' ${{ env.DOCKER_CONTAINER_NAME }} 2>/dev/null || echo 'exited')
            if [ \"\$CONTAINER_STATUS\" = \"restarting\" ]; then
              echo 'âŒ å®¹å™¨å¤„äºé‡å¯å¾ªç¯çŠ¶æ€ï¼'
              docker logs ${{ env.DOCKER_CONTAINER_NAME }} --tail 30
              exit 1
            elif [ \"\$CONTAINER_STATUS\" != \"running\" ]; then
              echo 'âŒ å®¹å™¨æœªè¿è¡Œï¼ŒçŠ¶æ€ï¼š'\$CONTAINER_STATUS
              docker logs ${{ env.DOCKER_CONTAINER_NAME }}
              exit 1
            fi
            echo 'âœ… å®¹å™¨è¿è¡ŒçŠ¶æ€æ­£å¸¸'

            echo -e '\n===== 2. éªŒè¯ç«¯å£æ˜¯å¦ç›‘å¬ ====='
            PORT_LISTEN=\$(ss -tlnp 2>/dev/null | grep -E \":${{ env.APP_PORT }}\b\" | wc -l)
            if [ \$PORT_LISTEN -eq 0 ]; then
              echo 'âŒ ç«¯å£${{ env.APP_PORT }}æœªç›‘å¬'
              ss -tlnp | grep -E 'docker|${{ env.APP_PORT }}'
              exit 1
            fi
            echo 'âœ… ç«¯å£${{ env.APP_PORT }}ç›‘å¬æ­£å¸¸'

            echo -e '\n===== 3. éªŒè¯HTTPå¯è®¿é—® ====='
            HTTP_CODE=\$(curl -s -o /dev/null -w '%{http_code}' http://127.0.0.1:${{ env.APP_PORT }}/ || echo '000')
            if [ \"\$HTTP_CODE\" != '200' ] && [ \"\$HTTP_CODE\" != '000' ]; then
              echo 'âš ï¸ HTTPè¿”å›ç ï¼š'\$HTTP_CODE
            elif [ \"\$HTTP_CODE\" = '000' ]; then
              echo 'âŒ HTTPæ— æ³•è®¿é—®'
              exit 1
            else
              echo 'âœ… HTTPè®¿é—®æ­£å¸¸ (200 OK)'
            fi

            echo -e '\n===== 4. éªŒè¯å®¹å™¨æ—¥å¿— ====='
            if docker logs ${{ env.DOCKER_CONTAINER_NAME }} 2>&1 | grep -i 'error\|panic\|fatal'; then
              echo 'âš ï¸ å®¹å™¨æ—¥å¿—ä¸­å‘ç°é”™è¯¯ï¼š'
              docker logs ${{ env.DOCKER_CONTAINER_NAME }} 2>&1 | grep -i 'error\|panic\|fatal' | head -10
            else
              echo 'âœ… å®¹å™¨æ—¥å¿—æ— æ˜æ˜¾é”™è¯¯'
            fi
          "
          echo "âœ… Dockeréƒ¨ç½²éªŒè¯é€šè¿‡"